"""Course list/detail and enrolment actions (Stage 5)."""
from __future__ import annotations

from django.contrib import messages
from django.contrib.auth.decorators import login_required
from django.core.exceptions import PermissionDenied
from django.http import HttpRequest, HttpResponse
from django.shortcuts import get_object_or_404, redirect, render

from accounts.decorators import role_required
from accounts.models import Role
from .forms import CourseForm
from .models import Course, Enrolment


def _is_enrolled(user, course: Course) -> bool:
    if not getattr(user, "is_authenticated", False):
        return False
    return Enrolment.objects.filter(course=course, student=user).exists()


def course_list(request: HttpRequest) -> HttpResponse:
    """Public course catalogue; actions vary by role."""
    courses = Course.objects.select_related("owner").all()
    enrolments = set()
    if request.user.is_authenticated:
        enrolments = set(Enrolment.objects.filter(student=request.user).values_list("course_id", flat=True))
    ctx = {"courses": courses, "enrolled_ids": enrolments, "role": getattr(getattr(request.user, "profile", None), "role", None)}
    return render(request, "courses/list.html", ctx)


@login_required
@role_required(Role.TEACHER)
def course_create(request: HttpRequest) -> HttpResponse:
    """Teacher-only course creation."""
    if request.method == "POST":
        form = CourseForm(request.POST)
        if form.is_valid():
            course = form.save(commit=False)
            course.owner = request.user
            course.save()
            messages.success(request, "Course created.")
            return redirect("courses:detail", pk=course.pk)
    else:
        form = CourseForm()
    return render(request, "courses/create.html", {"form": form})


@login_required
def course_detail(request: HttpRequest, pk: int) -> HttpResponse:
    """Course detail restricted to owner or enrolled students."""
    course = get_object_or_404(Course.objects.select_related("owner"), pk=pk)
    if not (course.is_owner(request.user) or _is_enrolled(request.user, course)):
        raise PermissionDenied

    # For teachers, show roster; for students, show a concise message.
    roster = None
    if course.is_owner(request.user):
        roster = (
            Enrolment.objects.filter(course=course).select_related("student").order_by("student__username")
        )
    ctx = {"course": course, "roster": roster}
    return render(request, "courses/detail.html", ctx)


@login_required
@role_required(Role.STUDENT)
def course_enrol(request: HttpRequest, pk: int) -> HttpResponse:
    """Enrol the current student into a course (idempotent)."""
    course = get_object_or_404(Course, pk=pk)
    if request.method == "POST":
        _, created = Enrolment.objects.get_or_create(course=course, student=request.user)
        if created:
            messages.success(request, "Enrolled in course.")
        return redirect("courses:detail", pk=course.pk)
    return redirect("courses:list")


@login_required
@role_required(Role.TEACHER)
def course_remove_student(request: HttpRequest, pk: int, user_id: int) -> HttpResponse:
    """Teacher removes a student from their course.

    Permission: only the course owner can remove students.
    """
    course = get_object_or_404(Course, pk=pk)
    if not course.is_owner(request.user):
        raise PermissionDenied
    if request.method == "POST":
        Enrolment.objects.filter(course=course, student_id=user_id).delete()
        messages.success(request, "Student removed from course.")
    return redirect("courses:detail", pk=course.pk)



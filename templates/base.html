<!doctype html>
<html lang="en-CA">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{% block title %}Courpera{% endblock %}</title>
    <link rel="icon" href="/static/favicon.svg" type="image/svg+xml">
    <link rel="alternate icon" href="/favicon.ico">
    <style>
      /* Minimal, readable defaults (accessible contrast) */
      :root { --bg: #ffffff; --fg: #111827; --muted: #374151; --accent: #0056D2; --card: #F3F4F6; }
      html { -webkit-text-size-adjust: 100%; }
      body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; background: var(--bg); color: var(--fg); line-height: 1.5; }
      header, main { max-width: 960px; margin: 0 auto; padding: 1.25rem; }
      a { color: var(--accent); text-decoration: none; }
      a:hover, a:focus { text-decoration: underline; }
      .muted { color: var(--muted); }
      .panel { background: var(--card); border-radius: 8px; padding: 1rem 1.25rem; }
      .grid { display: grid; gap: 1rem; }
      .grid-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
      @media (max-width: 720px) { .grid-2 { grid-template-columns: 1fr; } }
      .kv { display: grid; grid-template-columns: 160px 1fr; gap: .25rem .75rem; }
      .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); white-space: nowrap; border: 0; }
      .link-btn { background: none; border: 0; color: var(--accent); cursor: pointer; padding: 0; font: inherit; }
      .link-btn:hover, .link-btn:focus { text-decoration: underline; }
    </style>
  </head>
  <body>
    <a class="sr-only" href="#main">Skip to content</a>
    <header role="banner">
      <h1><a href="/">Courpera</a></h1>
      <nav aria-label="Primary" style="position:relative; display:flex; gap:0.75rem; align-items:center; flex-wrap:wrap">
        {% if request.user.is_authenticated %}
          <a href="/accounts/home/">Home</a>
          <a href="/courses/">Courses</a>
          {% if request.user.profile and request.user.profile.role == 'teacher' %}
          <form method="get" action="/accounts/search/" style="display:inline">
            <label for="hdrq" class="sr-only">Search users</label>
            <input id="hdrq" name="q" type="search" placeholder="Search usersâ€¦" style="padding:0.2rem 0.4rem" />
          </form>
          {% endif %}
          <button id="notifBtn" class="link-btn" type="button">Notifications <span id="notifBadge" class="muted"></span></button>
          <div id="notifPanel" style="display:none; position:absolute; background:#fff; border:1px solid #ddd; padding:.5rem; border-radius:6px; max-width:360px; z-index:1000; right:0;">
            <strong>Recent</strong>
            <ul id="notifList" style="margin:.5rem 0; padding-left:1rem"></ul>
            <div>
              <form method="post" action="/activity/notifications/mark-all-read/">
                {% csrf_token %}
                <button type="submit" class="link-btn">Mark all read</button>
                <a href="/activity/notifications/">View all</a>
              </form>
            </div>
          </div>
          <form method="post" action="/accounts/logout/" style="display:inline">
            {% csrf_token %}
            <button type="submit" class="link-btn">Sign out</button>
          </form>
        {% else %}
          <a href="/courses/">Courses</a>
          <a href="/accounts/login/">Sign in</a>
          <a href="/accounts/register/">Register</a>
        {% endif %}
      </nav>
    </header>
    {% if messages %}
    <div class="panel" aria-live="polite" style="max-width:960px;margin:0 auto 1rem auto">
      <ul style="margin:0;padding-left:1.2rem">
        {% for message in messages %}
          <li class="muted">{{ message }}</li>
          {% if 'error' in message.tags %}
            <script>try{ alert('{{ message|escapejs }}'); }catch(e){}</script>
          {% endif %}
        {% endfor %}
      </ul>
    </div>
    {% endif %}
    <main id="main" role="main">
      {% block content %}{% endblock %}
    </main>
  <script>
    (function(){
      var btn = document.getElementById('notifBtn');
      var panel = document.getElementById('notifPanel');
      var list = document.getElementById('notifList');
      var badge = document.getElementById('notifBadge');
      if(!btn || !panel) return;
      function fetchRecent(){
        fetch('/activity/notifications/recent/')
          .then(function(r){ return r.ok ? r.json() : {unread:0,results:[]}; })
          .then(function(d){
            badge.textContent = d.unread ? '(' + d.unread + ')' : '';
            list.innerHTML = '';
            (d.results || []).forEach(function(n){
              var li = document.createElement('li');
              li.textContent = n.message;
              list.appendChild(li);
            });
            if((d.results||[]).length === 0){
              var li = document.createElement('li'); li.textContent = 'No notifications'; list.appendChild(li);
            }
          })
          .catch(function(){});
      }
      btn.addEventListener('click', function(){
        var show = panel.style.display === 'none';
        panel.style.display = show ? 'block' : 'none';
        if(show){ fetchRecent(); }
      });
      document.addEventListener('click', function(e){
        if(!panel.contains(e.target) && e.target !== btn){ panel.style.display='none'; }
      });
    })();
  </script>
  </body>
  <!-- Stage 1: keep markup simple and semantic; more structure follows -->
</html>

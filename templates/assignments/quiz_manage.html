{% extends "base.html" %}
{% block title %}Manage Quiz - {{ block.super }}{% endblock %}
{% block content %}
  <section class="panel">
    <div class="panel-heading">
      <h3>Manage Quiz - {{ assignment.title }}</h3>
      <div class="action-right">
        <span class="muted">{% if assignment.is_published %}Published{% else %}Draft{% endif %}</span>
        {% if not locked %}
        <form method="post" action="" class="inline" novalidate>
          {% csrf_token %}
          {% if not assignment.is_published %}
            <input type="hidden" name="action" value="publish" />
            <button type="submit" class="btn" formnovalidate {% if not ready_info.ready %}disabled title="Add at least one question; each must have exactly one correct answer and at least two choices."{% endif %}>Publish</button>
          {% else %}
            <input type="hidden" name="action" value="unpublish" />
            <button type="submit" class="btn-secondary" formnovalidate data-confirm="Unpublish this assignment? Students won't be able to submit until republished.">Unpublish</button>
          {% endif %}
        </form>
        {% endif %}
        <a href="/assignments/{{ assignment.id }}/attempts/" class="btn-secondary">Attempts</a>
        <a href="/assignments/course/{{ assignment.course.id }}/" class="btn-secondary">Back to assignments</a>
      </div>
    </div>
    <form method="post" action="" class="mb-2">
      {% csrf_token %}
      <div class="kv"> 
        <label for="id_title">Title</label> 
        {{ meta_form.title }} 
        {{ meta_form.title.errors }} 
        <label for="id_instructions">Instructions</label>
        {{ meta_form.instructions }}
        {{ meta_form.instructions.errors }}
        <label for="id_available_from">Available</label>
        <div class="answer-row">
          {{ meta_form.available_from }}
          <button type="submit" name="action" value="set_available_now" class="btn-link" formnovalidate>Now</button>
        </div>
        {{ meta_form.available_from.errors }}
        <label for="id_deadline">Deadline</label>
        <div class="answer-row">
          {{ meta_form.deadline }}
          <select name="deadline_delta" class="input-sm">
            <option value="1d">One day</option>
            <option value="3d">Three days</option>
            <option value="1w">One week</option>
            <option value="2w">Two weeks</option>
            <option value="1m">One month</option>
            <option value="3m">Three months</option>
          </select>
          <button type="submit" name="action" value="set_deadline_delta" class="btn-link" formnovalidate>Set</button>
        </div>
        {{ meta_form.deadline.errors }} 
        <label for="id_attempts_allowed">Attempts</label>
        {{ meta_form.attempts_allowed }}
        {{ meta_form.attempts_allowed.errors }}
        <div></div>
        <p class="muted">At least 1; cannot be less than attempts already used.</p>
        <label for="id_max_marks">Max marks</label>
        {{ meta_form.max_marks }}
        {{ meta_form.max_marks.errors }}
        <div></div>
        <p class="muted">Default 100. Used in course percentage.</p>
      </div> 
      <button type="submit" name="action" value="update_meta" class="btn-secondary">Save details</button> 
    </form> 
    <div>
      {% if ready_info.ready %}
        <p class="muted" aria-live="polite">Status: Ready for students.</p>
      {% else %}
        <p class="muted" aria-live="polite">Status: Needs corrections{% if ready_info.issues %}: {{ ready_info.issues|join:", " }}{% endif %}.</p>
      {% endif %}
      <p class="muted">Open when: <strong>Published</strong>, <strong>Ready</strong>, and <strong>Available</strong> time reached.</p>
      <p class="muted">All times in Mountain Time.</p>
    </div>
    {% if locked %}
      <p class="muted">Quiz is locked (attempts exist). You can no longer edit questions or answers.</p>
    {% endif %}
    <h4>Questions</h4>
    <ul>
      {% for q in assignment.questions.all %}
        <li>
          <div class="answer-row">
            <div><strong>Q{{ q.order }}.</strong> {{ q.text }}</div>
            {% if not locked %}
            <form method="post" action="" class="inline">
              {% csrf_token %}
              <input type="hidden" name="question_id" value="{{ q.id }}" /> 
              <input type="text" name="text" value="{{ q.text }}" class="input-sm w-50" aria-label="Edit question" /> 
              <button type="submit" name="action" value="update_question" class="btn-secondary">Save</button> 
              <button type="submit" name="action" value="delete_question" class="btn-link" data-confirm="Delete this question?">Delete</button>
            </form>
            {% endif %}
          </div>
          
          <ul>
            {% for c in q.choices.all %}
              <li class="answer-row">
                <div>{{ c.text }}</div>
                <div class="answer-actions">
                  {% if c.is_correct %}
                    <span class="muted">[Correct]</span>
                  {% elif not locked %}
                    <form method="post" action="" class="inline">
                      {% csrf_token %}
                      <input type="hidden" name="action" value="mark_correct" />
                      <input type="hidden" name="choice_id" value="{{ c.id }}" />
                      <button type="submit" class="btn-link">Mark correct</button>
                    </form>
                  {% endif %}
                  {% if not locked %}
                    <form method="post" action="" class="inline" data-confirm="Delete this answer?">
                      {% csrf_token %}
                      <input type="hidden" name="action" value="delete_choice" />
                      <input type="hidden" name="choice_id" value="{{ c.id }}" />
                      <button type="submit" class="btn-link">Delete</button>
                    </form>
                  {% endif %}
                </div>
              </li>
            {% empty %}
              <li class="muted">No answers yet.</li>
            {% endfor %}
          </ul>
          {% if not locked %}
          <form method="post" action="" class="inline-form">
            {% csrf_token %}
            <input type="hidden" name="action" value="add_choice" />
            <input type="hidden" name="question_id" value="{{ q.id }}" />
            <div class="choice-add">
              {{ c_form.text }}
              <label>{{ c_form.is_correct }} Correct?</label>
            </div>
            <button type="submit" class="btn">Add answer</button>
          </form>
          {% endif %}
        </li>
      {% empty %}
        <li class="muted">No questions yet.</li>
      {% endfor %}
    </ul>

    {% if not locked %}
    <h4>Add a question</h4>
    <form method="post" action="">
      {% csrf_token %}
      <input type="hidden" name="action" value="add_question" />
      <div class="kv">
        <label for="id_text">Question</label>
        {{ q_form.text }}
      </div>
      <button type="submit" class="btn">Add question</button>
    </form>
    {% endif %}
  </section>
{% endblock %}

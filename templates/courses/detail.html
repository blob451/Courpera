{% extends "base.html" %}
{% load avatar %}
{% block title %}{{ course.title }} — {{ block.super }}{% endblock %}
{% block content %}
  <section class="panel hero">
    {% if breadcrumbs %}
    <nav aria-label="Breadcrumbs" class="breadcrumbs mb-2">
      {% for href, label in breadcrumbs %}
        {% if forloop.last %}
          <span class="muted">{{ label }}</span>
        {% else %}
          <a href="{{ href }}">{{ label }}</a> <span class="muted">/</span>
        {% endif %}
      {% endfor %}
    </nav>
    {% endif %}
    <div class="panel-heading">
      <h2>{{ course.title }}</h2>
      {% if owner_view %}<a class="btn-secondary action-right" href="/courses/{{ course.id }}/edit/">Edit course</a>{% endif %}
    </div>
    {% if course.description %}
      <p>{{ course.description }}</p>
    {% endif %}
    <p class="muted">Teacher: {{ course.owner.username }}</p>
    <div class="hero-actions">
      {% if owner_view %}
      {% elif is_enrolled %}
        <form method="post" action="/courses/{{ course.id }}/unenrol/" class="inline">
          {% csrf_token %}
          <button type="submit" class="btn">Unenrol</button>
        </form>
      {% elif not limited_view %}
        <form method="post" action="/courses/{{ course.id }}/enrol/" class="inline">
          {% csrf_token %}
          <button type="submit" class="btn">Enrol for free</button>
        </form>
      {% endif %}
      <a class="btn-link" href="/courses/{{ course.id }}/calendar.ics">Download calendar (.ics)</a>
    </div>
  </section>

  {% if owner_view or is_enrolled %}
  <!-- Syllabus first -->
  <section class="panel">
    <div class="panel-heading">
      <h3>Syllabus</h3>
      {% if owner_view %}<a class="btn-secondary action-right" href="/courses/{{ course.id }}/syllabus/edit/">Edit syllabus</a>{% endif %}
    </div>
    <div class="accordion" data-accordion>
      <div class="accordion-item">
        <button type="button" class="accordion-button" aria-expanded="true" aria-controls="syllabus-panel">
          Weekly outline <span class="chev">›</span>
        </button>
        <div id="syllabus-panel" class="accordion-panel">
          {% if syllabus_lines %}
          <ul>
            {% for it in syllabus_lines %}
            <li>{{ it }}</li>
            {% endfor %}
          </ul>
          {% elif course.materials.all %}
          <ul>
            {% for m in course.materials.all %}
            <li>{{ forloop.counter }}. {{ m.title }}</li>
            {% endfor %}
          </ul>
          {% else %}
          <p class="muted">Syllabus will appear here as materials are added.</p>
          {% endif %}
        </div>
      </div>
      <div class="accordion-item">
        <button type="button" class="accordion-button" aria-expanded="false" aria-controls="outcomes-panel">
          What you'll learn <span class="chev">›</span>
        </button>
        <div id="outcomes-panel" class="accordion-panel" hidden>
          {% if outcome_lines %}
          <ul>
            {% for it in outcome_lines %}
            <li>{{ it }}</li>
            {% endfor %}
          </ul>
          {% else %}
          <ul>
            <li>Understand core concepts of the course.</li>
            <li>Work with real-world examples and exercises.</li>
            <li>Build confidence through hands-on practice.</li>
          </ul>
          {% endif %}
        </div>
      </div>
    </div>
    <div class="instructor mt-2">
      <img src="{% avatar_url course.owner 48 %}" alt="" />
      <div>
        <div><strong>{{ course.owner.username }}</strong></div>
        {% if course.owner.profile.full_name %}
          <div class="muted">{{ course.owner.profile.full_name }}</div>
        {% endif %}
        <div class="muted">Partner: Courpera</div>
      </div>
    </div>
  </section>
  <!-- Then Course chat below Syllabus -->
  <section class="panel" data-chat-course-id="{{ course.id }}">
    <h3>Course chat</h3>
    <div id="chat-log" class="chat-log"></div>
    <form id="chat-form">
      <label class="sr-only" for="chat-input">Message</label>
      <input id="chat-input" type="text" maxlength="500" placeholder="Type a message..." class="input w-80" />
      <button type="submit">Send</button>
    </form>
  </section>
  <!-- Then Materials under Syllabus/Chat -->
  <section class="panel">
    <h3>Materials</h3>
    <ul>
      {% for m in course.materials.all %}
        <li>
          <a href="{{ m.file.url }}" target="_blank" rel="noopener noreferrer">{{ m.title }}</a>
          <span class="muted">({{ m.size_bytes }} bytes)</span>
          {% if owner_view %}
          <form method="post" action="/materials/{{ m.id }}/delete/" class="inline">
            {% csrf_token %}
            <button type="submit">Delete</button>
          </form>
          {% endif %}
        </li>
      {% empty %}
        <li>No materials yet.</li>
      {% endfor %}
    </ul>
    {% if owner_view %}
    <form method="post" action="/materials/course/{{ course.id }}/upload/" enctype="multipart/form-data">
      {% csrf_token %}
      <div class="kv">
        <label for="id_title">Title</label>
        <input type="text" name="title" id="id_title" maxlength="200" required />
        <label for="id_file">File (PDF/JPEG/PNG/WEBP, ≤25 MB)</label>
        <input type="file" name="file" id="id_file" accept="application/pdf,image/jpeg,image/png,image/webp" required />
      </div>
      <button type="submit">Upload</button>
    </form>
    {% endif %}
  </section>
  {% endif %}

  {% if owner_view %}
  <section class="panel">
    <h3>Course enrolment</h3>
    <p class="muted">Teacher-only view. Manage enrolments.</p>
    <ul>
      {% for e in roster %}
        <li>
          <img src="{% avatar_url e.student 32 %}" alt="" class="avatar" />
          {{ e.student.username }}
          {% with sid=e.student.profile.student_number %}
            {% if sid %} ({{ sid }}){% else %} (S{{ e.student.id|stringformat:'07d' }}){% endif %}
          {% endwith %}
          <form method="post" action="/courses/{{ course.id }}/remove/{{ e.student.id }}/" class="inline">
            {% csrf_token %}
            <button type="submit">Remove</button>
          </form>
        </li>
      {% empty %}
        <li>No students enrolled yet.</li>
      {% endfor %}
    </ul>
    <hr />
    <form method="post" action="/courses/{{ course.id }}/add-student/">
      {% csrf_token %}
      <div class="kv">
        <label for="id_query">Username, e-mail, or Student ID</label>
        {{ add_form.query }}
      </div>
      <button type="submit" name="action" value="search">Search</button>
    </form>
    {% if searched and search_results|length == 0 %}
      <p class="muted">No users found.</p>
    {% endif %}
    {% if search_results %}
      <h4>Search results</h4>
      <ul>
        {% for u in search_results %}
          <li>
            {{ u.username }}
            {% with sid=u.profile.student_number %}
              {% if sid %} ({{ sid }}){% else %} (S{{ u.id|stringformat:'07d' }}){% endif %}
            {% endwith %}
            {% if u.email %} <span class="muted">({{ u.email }})</span>{% endif %}
            <form method="post" action="/courses/{{ course.id }}/add-student/" class="inline">
              {% csrf_token %}
              <input type="hidden" name="query" value="{{ u.username }}">
              <button type="submit" name="action" value="enrol">Enrol</button>
            </form>
          </li>
        {% endfor %}
      </ul>
    {% endif %}
  </section>
  {% endif %}

  {% if not owner_view and is_enrolled %}
  {% endif %}

  <section class="panel">
    <h3>Feedback</h3>
    <ul>
      {% for fb in feedback_list %}
        <li>
          <strong>{{ fb.rating }}/5</strong>
          — {% if fb.anonymous %}Anonymous{% else %}{{ fb.student.username }}{% endif %}
          {% if fb.comment %}<div>{{ fb.comment }}</div>{% endif %}
        </li>
      {% empty %}
        <li>No feedback yet.</li>
      {% endfor %}
    </ul>
  </section>
  {% if not owner_view and is_enrolled %}
  <section class="panel">
    <h3>Leave feedback</h3>
    <form method="post" action="/courses/{{ course.id }}/feedback/">
      {% csrf_token %}
      <div class="kv">
        <label for="id_rating">Rating (1‑5)</label>
        {{ feedback_form.rating }}
        <label for="id_comment">Comment</label>
        {{ feedback_form.comment }}
        <label for="id_anonymous">Anonymous</label>
        {{ feedback_form.anonymous }}
      </div>
      <button type="submit">Save feedback</button>
    </form>
  </section>
  {% endif %}

  
{% endblock %}

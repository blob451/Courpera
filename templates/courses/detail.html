{% extends "base.html" %}
{% block title %}{{ course.title }} — {{ block.super }}{% endblock %}
{% block content %}
  <section class="panel">
    <h2>{{ course.title }}</h2>
    {% if course.description %}
      <p>{{ course.description }}</p>
    {% endif %}
    <p class="muted">Teacher: {{ course.owner.username }}</p>
    {% if owner_view %}
      <p><a href="/courses/{{ course.id }}/edit/">Edit course</a></p>
    {% endif %}
  </section>

  <section class="panel">
    <h3>Materials</h3>
    <ul>
      {% for m in course.materials.all %}
        <li>
          <a href="{{ m.file.url }}" target="_blank" rel="noopener noreferrer">{{ m.title }}</a>
          <span class="muted">({{ m.size_bytes }} bytes)</span>
          {% if owner_view %}
          <form method="post" action="/materials/{{ m.id }}/delete/" style="display:inline">
            {% csrf_token %}
            <button type="submit">Delete</button>
          </form>
          {% endif %}
        </li>
      {% empty %}
        <li>No materials yet.</li>
      {% endfor %}
    </ul>
    {% if owner_view %}
    <form method="post" action="/materials/course/{{ course.id }}/upload/" enctype="multipart/form-data">
      {% csrf_token %}
      <div class="kv">
        <label for="id_title">Title</label>
        <input type="text" name="title" id="id_title" maxlength="200" required />
        <label for="id_file">File (PDF/JPEG/PNG/WEBP, ≤25 MB)</label>
        <input type="file" name="file" id="id_file" accept="application/pdf,image/jpeg,image/png,image/webp" required />
      </div>
      <button type="submit">Upload</button>
    </form>
    {% if messages %}
      <script>
        try {
          {% for message in messages %}
            {% if 'error' in message.tags %}
              alert('{{ message|escapejs }}');
            {% endif %}
          {% endfor %}
        } catch (e) { /* no-op */ }
      </script>
    {% endif %}
    <script>
      (function(){
        var fi = document.getElementById('id_file');
        var ti = document.getElementById('id_title');
        if (fi && ti) {
          fi.addEventListener('change', function(){
            try {
              if (!ti.value && fi.files && fi.files[0] && fi.files[0].name) {
                var n = fi.files[0].name;
                var base = n.replace(/\.[^.]+$/, '');
                ti.value = base;
              }
            } catch (e) { /* no-op */ }
          });
        }
      })();
    </script>
    {% endif %}
  </section>

  {% if owner_view %}
  <section class="panel">
    <h3>Roster</h3>
    <p class="muted">Teacher-only view. Remove students as needed.</p>
    <ul>
      {% for e in roster %}
        <li>
          {{ e.student.username }}
          <form method="post" action="/courses/{{ course.id }}/remove/{{ e.student.id }}/" style="display:inline">
            {% csrf_token %}
            <button type="submit">Remove</button>
          </form>
        </li>
      {% empty %}
        <li>No students enrolled yet.</li>
      {% endfor %}
    </ul>
  </section>
  <section class="panel">
    <h3>Add student</h3>
    <form method="post" action="/courses/{{ course.id }}/add-student/">
      {% csrf_token %}
      <div class="kv">
        <label for="id_query">Username or e‑mail</label>
        {{ add_form.query }}
      </div>
      <button type="submit" name="action" value="search">Search</button>
    </form>
    {% if searched and search_results|length == 0 %}
      <script>try{ alert('No users found'); }catch(e){/*no-op*/}</script>
    {% endif %}
    {% if search_results %}
      <h4>Search results</h4>
      <ul>
        {% for u in search_results %}
          <li>
            {{ u.username }}{% if u.email %} <span class="muted">({{ u.email }})</span>{% endif %}
            <form method="post" action="/courses/{{ course.id }}/add-student/" style="display:inline">
              {% csrf_token %}
              <input type="hidden" name="query" value="{{ u.username }}">
              <button type="submit" name="action" value="enrol">Enrol</button>
            </form>
          </li>
        {% endfor %}
      </ul>
    {% endif %}
  </section>
  {% endif %}

  {% if not owner_view and is_enrolled %}
  <section class="panel">
    <h3>Course actions</h3>
    <form method="post" action="/courses/{{ course.id }}/unenrol/">
      {% csrf_token %}
      <button type="submit">Unenrol from course</button>
    </form>
  </section>
  {% endif %}
{% endblock %}

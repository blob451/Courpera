{% extends "base.html" %}
{% load avatar %}
{% block title %}{{ course.title }} — {{ block.super }}{% endblock %}
{% block content %}
  <section class="panel hero">
    {% if breadcrumbs %}
    <nav aria-label="Breadcrumbs" class="breadcrumbs mb-2">
      {% for href, label in breadcrumbs %}
        {% if forloop.last %}
          <span class="muted">{{ label }}</span>
        {% else %}
          <a href="{{ href }}">{{ label }}</a> <span class="muted">/</span>
        {% endif %}
      {% endfor %}
    </nav>
    {% endif %}
    <h2>{{ course.title }}</h2>
    {% if course.description %}
      <p>{{ course.description }}</p>
    {% endif %}
    <p class="muted">Teacher: {{ course.owner.username }}</p>
    <div class="hero-actions">
      {% if owner_view %}
        <a class="btn" href="/courses/{{ course.id }}/edit/">Edit course</a>
      {% elif is_enrolled %}
        <form method="post" action="/courses/{{ course.id }}/unenrol/" class="inline">
          {% csrf_token %}
          <button type="submit" class="btn">Unenrol</button>
        </form>
      {% elif not limited_view %}
        <form method="post" action="/courses/{{ course.id }}/enrol/" class="inline">
          {% csrf_token %}
          <button type="submit" class="btn">Enrol for free</button>
        </form>
      {% endif %}
      <a class="btn-link" href="/courses/{{ course.id }}/calendar.ics">Download calendar (.ics)</a>
      <span class="badge">Flexible deadlines</span>
    </div>
  </section>

  {% if owner_view or is_enrolled %}
  <section class="panel">
    <h3>Materials</h3>
    <ul>
      {% for m in course.materials.all %}
        <li>
          <a href="{{ m.file.url }}" target="_blank" rel="noopener noreferrer">{{ m.title }}</a>
          <span class="muted">({{ m.size_bytes }} bytes)</span>
          {% if owner_view %}
          <form method="post" action="/materials/{{ m.id }}/delete/" class="inline">
            {% csrf_token %}
            <button type="submit">Delete</button>
          </form>
          {% endif %}
        </li>
      {% empty %}
        <li>No materials yet.</li>
      {% endfor %}
    </ul>
    {% if owner_view %}
    <form method="post" action="/materials/course/{{ course.id }}/upload/" enctype="multipart/form-data">
      {% csrf_token %}
      <div class="kv">
        <label for="id_title">Title</label>
        <input type="text" name="title" id="id_title" maxlength="200" required />
        <label for="id_file">File (PDF/JPEG/PNG/WEBP, ≤25 MB)</label>
        <input type="file" name="file" id="id_file" accept="application/pdf,image/jpeg,image/png,image/webp" required />
      </div>
      <button type="submit">Upload</button>
    </form>
    {% endif %}
  </section>
  <section class="panel" data-chat-course-id="{{ course.id }}">
    <h3>Course chat</h3>
    <div id="chat-log" class="chat-log"></div>
    <form id="chat-form">
      <label class="sr-only" for="chat-input">Message</label>
      <input id="chat-input" type="text" maxlength="500" placeholder="Type a message..." class="input w-80" />
      <button type="submit">Send</button>
    </form>
  </section>
  {% endif %}

  {% if owner_view %}
  <section class="panel">
    <h3>Roster</h3>
    <p class="muted">Teacher-only view. Remove students as needed.</p>
    <ul>
      {% for e in roster %}
        <li>
          <img src="{% avatar_url e.student 32 %}" alt="" class="avatar" referrerpolicy="no-referrer" />
          {{ e.student.username }}
          <form method="post" action="/courses/{{ course.id }}/remove/{{ e.student.id }}/" class="inline">
            {% csrf_token %}
            <button type="submit">Remove</button>
          </form>
        </li>
      {% empty %}
        <li>No students enrolled yet.</li>
      {% endfor %}
    </ul>
  </section>
  <section class="panel">
    <h3>Add student</h3>
    <form method="post" action="/courses/{{ course.id }}/add-student/">
      {% csrf_token %}
      <div class="kv">
        <label for="id_query">Username or e‑mail</label>
        {{ add_form.query }}
      </div>
      <button type="submit" name="action" value="search">Search</button>
    </form>
    {% if searched and search_results|length == 0 %}
      <p class="muted">No users found.</p>
    {% endif %}
    {% if search_results %}
      <h4>Search results</h4>
      <ul>
        {% for u in search_results %}
          <li>
            {{ u.username }}{% if u.email %} <span class="muted">({{ u.email }})</span>{% endif %}
            <form method="post" action="/courses/{{ course.id }}/add-student/" class="inline">
              {% csrf_token %}
              <input type="hidden" name="query" value="{{ u.username }}">
              <button type="submit" name="action" value="enrol">Enrol</button>
            </form>
          </li>
        {% endfor %}
      </ul>
    {% endif %}
  </section>
  {% endif %}

  {% if not owner_view and is_enrolled %}
  <section class="panel">
    <h3>Course actions</h3>
    <form method="post" action="/courses/{{ course.id }}/unenrol/">
      {% csrf_token %}
      <button type="submit">Unenrol from course</button>
    </form>
  </section>
  <section class="panel">
    <h3>Leave feedback</h3>
    <form method="post" action="/courses/{{ course.id }}/feedback/">
      {% csrf_token %}
      <div class="kv">
        <label for="id_rating">Rating (1‑5)</label>
        {{ feedback_form.rating }}
        <label for="id_comment">Comment</label>
        {{ feedback_form.comment }}
        <label for="id_anonymous">Anonymous</label>
        {{ feedback_form.anonymous }}
      </div>
      <button type="submit">Save feedback</button>
    </form>
  </section>
  {% endif %}

  <section class="panel">
    <h3>Feedback</h3>
    <ul>
      {% for fb in feedback_list %}
        <li>
          <strong>{{ fb.rating }}/5</strong>
          — {% if fb.anonymous %}Anonymous{% else %}{{ fb.student.username }}{% endif %}
          {% if fb.comment %}<div>{{ fb.comment }}</div>{% endif %}
        </li>
      {% empty %}
        <li>No feedback yet.</li>
      {% endfor %}
    </ul>
  </section>
{% endblock %}
